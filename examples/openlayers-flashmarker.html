<!DOCTYPE html>
<html>

<head>
    <title>openlayers flashmarker</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="http://www.openlayers.cn/olapi/theme/default/style.css" type="text/css">
    <script type="text/javascript" src="http://www.openlayers.cn/olapi/OpenLayers.js"></script>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script type="text/javascript">
        function init() {
            OpenLayers.Layer.CanvasLayer = OpenLayers.Class(OpenLayers.Layer, {
                points: null,
                canvas: null,
                initialize: function (name, options) {
                    OpenLayers.Layer.prototype.initialize.apply(this, arguments);
                    this.points = [];

                    var canvas = this.canvas = document.createElement('canvas');
                    var ctx = this.ctx = this.canvas.getContext('2d');
                    canvas.style.cssText = 'position:absolute;' +
                        'left:0;' +
                        'top:0;' +
                        'z-index:0;border:1px solid red';
                    this.adjustRadio();
                    this.div.appendChild(canvas);
                },
                adjustSize: function () {
                    var size = this.map.getSize();
                    var canvas = this.canvas;
                    canvas.width = size.w;
                    canvas.height = size.h;
                    canvas.style.width = size.w + 'px';
                    canvas.style.height = size.h + 'px';
                },
                adjustRadio: function () {
                    var ctx = this.ctx;
                    var backingStore = ctx.backingStorePixelRatio ||
                        ctx.webkitBackingStorePixelRatio ||
                        ctx.mozBackingStorePixelRatio ||
                        ctx.msBackingStorePixelRatio ||
                        ctx.oBackingStorePixelRatio ||
                        ctx.backingStorePixelRatio || 1;
                    var pixelRatio = (window.devicePixelRatio || 1) / backingStore;
                    var canvasWidth = ctx.canvas.width;
                    var canvasHeight = ctx.canvas.height;
                    ctx.canvas.width = canvasWidth * pixelRatio;
                    ctx.canvas.height = canvasHeight * pixelRatio;
                    ctx.canvas.style.width = canvasWidth + 'px';
                    ctx.canvas.style.height = canvasHeight + 'px';
                    // console.log(ctx.canvas.height, canvasHeight);
                    ctx.scale(pixelRatio, pixelRatio);
                },
                moveTo: function (bounds, zoomChanged, dragging) {
                    var self = this;
                    self.adjustSize();
                    OpenLayers.Layer.prototype.moveTo.apply(self, arguments);

                    clearTimeout(self.timeoutID);
                    self.timeoutID = setTimeout(function () {
                        self._draw();
                    }, 15);
                },
                _draw: function () {
                    var map = this.map;
                    var size = map.getSize();
                    var center = map.getCenter();
                    if (center) {
                        var pixel = map.getLayerPxFromLonLat(center);
                        this.canvas.style.left = pixel.x - size.w / 2 + 'px';
                        this.canvas.style.top = pixel.y - size.h / 2 + 'px';

                        this.options.update && this.options.update.call(this);
                    }
                },
                CLASS_NAME: 'OpenLayers.Layer.CanvasLayer'
            });

            var map = new OpenLayers.Map({
                div: "map",
                theme: null,
                controls: [
                    new OpenLayers.Control.Navigation(),
                    new OpenLayers.Control.Attribution(),
                    new OpenLayers.Control.TouchNavigation({
                        dragPanOptions: {
                            enableKinetic: true
                        }
                    }),
                    new OpenLayers.Control.Zoom()
                ],
                layers: [
                    new OpenLayers.Layer.OSM("OpenStreetMap", null, {
                        transitionEffect: "resize",
                        attribution: "&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
                    })
                ]
            });
            map.setCenter(new OpenLayers.LonLat(116.397128, 39.916527).transform(
                new OpenLayers.Projection("EPSG:4326"),
                map.getProjectionObject()
            ), 3);
            var canvasLayer = new OpenLayers.Layer.CanvasLayer("grid", {
                map: map,
                update: function () {
                    console.log('canvas update');
                }
            });
            map.addLayer(canvasLayer);
        }

        if (document.all) {
            window.attachEvent('onload', init);
        } else {
            window.addEventListener('load', init, false);
        }
    </script>
</body>
</html